# 反復タスク一覧 (Tasks)

このドキュメントは、このプロジェクトで繰り返し発生するタスクの標準的なワークフローを記録します。

## 新しいデータ表示・編集ページの追加

**概要:**
SvelteKitのファイルベースルーティングを利用して、特定のデータ（例: ノート）の詳細表示ページと編集ページを作成する際の標準的な手順です。

**関連ファイルの例 (ノートの場合):**

- `src/routes/notes/[id]/+page.svelte`: 詳細表示ページ
- `src/routes/notes/[id]/edit/+page.svelte`: 編集ページ
- `src/routes/api/notes/[id]/+server.ts`: データアクセスAPI

**ステップ:**

1.  **APIエンドポイントの実装 (`+server.ts`)**
    - `GET`リクエストハンドラを作成し、パスパラメータ（例: `id`）に基づいてデータベースから単一のレコードを取得するロジックを実装します。
    - `PUT`リクエストハンドラを作成し、リクエストボディのデータでレコードを更新するロジックを実装します。
    - `DELETE`リクエストハンドラを作成し、レコードを削除するロジックを実装します。
    - Drizzle ORMを使用して、型安全なデータベース操作を行います。
    - 認証をチェックし、適切なユーザーのみがデータにアクセスできるようにします。

2.  **詳細表示ページの実装 (`+page.svelte`)**
    - `+page.server.ts` の `load` 関数内で、`fetch` を使用して対応するAPIエンドポイント（`GET /api/notes/{id}`）を呼び出し、データを取得します。
    - 取得したデータをページに表示します。タイトル、内容、関連情報（タグ、作成日時など）を適切にフォーマットします。
    - 編集ページへのリンクと、削除ボタンを配置します。

3.  **編集ページの実装 (`edit/+page.svelte`)**
    - `+page.server.ts` の `load` 関数で、表示ページと同様にデータを取得し、フォームの初期値として設定します。
    - フォーム (`<form>`) と入力フィールド（`input`, `textarea`など）を作成します。UIにはDaisyUIコンポーネントを優先的に使用します。
    - SvelteKitのフォームアクションを使用して、フォーム送信時に`PUT`リクエストをAPIエンドポイントに送信し、データを更新します。
    - 更新が成功したら、詳細表示ページにリダイレクトします。

**重要事項:**

- **認証:** すべてのデータアクセスと操作は、`src/hooks.server.ts` を通じて認証されていることを前提とします。APIエンドポイントと `load` 関数の両方で、ユーザーセッションを適切に処理する必要があります。
- **型安全:** `src/lib/types.ts` やDrizzleのスキーマから型をインポートし、コンポーネントとAPI間のデータの受け渡しを型安全に行います。

## Markdownプレビュー表示のカスタマイズ

**概要:**
メモのプレビュー表示で、Markdownの特定の要素（太字、リンク、インラインコードなど）をHTMLとして表示する機能の実装とカスタマイズに関するタスクです。

**関連ファイル:**

- `src/lib/components/MemoCard.svelte`: メモのプレビュー表示コンポーネント

**ステップ:**

1.  **要件の確認:**
    - どのMarkdown要素をHTMLとして表示する必要があるかを確認します（例: 太字、リンク、インラインコード）。
    - 表示の制限やセキュリティ上の考慮事項を確認します。

2.  **実装の検討:**
    - MarkdownをHTMLに変換するライブラリ（markedなど）を使用します。
    - HTMLタグをフィルタリングして、許可された要素のみを保持する処理を実装します。
    - テキストの切り捨て処理をHTML対応にするか検討します。

3.  **コンポーネントの修正:**
    - プレビュー表示部分で`{@html}`ディレクティブを使用してHTMLコンテンツをレンダリングします。
    - CSSスタイルを調整して、HTMLコンテンツがカード内に適切に表示されるようにします。

4.  **テストと検証:**
    - 各Markdown要素が正しく表示されることを確認します。
    - セキュリティ上のリスクがないか評価します。
    - レスポンシブデザインが崩れていないか確認します。

**重要事項:**

- **セキュリティ:** 信頼できないHTMLをレンダリングするとXSSのリスクがあります。適切なサニタイズ処理を実装する必要があります。
- **パフォーマンス:** 複雑なHTML処理はパフォーマンスに影響する可能性があります。必要に応じて最適化を検討します。
- **UI/UX:** HTML要素のスタイルが全体のデザインと調和するようにCSSを調整します。
- **UI/UX:** DaisyUIのコンポーネントとテーマカラーを利用して、一貫性のあるUIを構築します。

## Wikiリンク機能の実装

**概要:**
Markdownエディタ内でのWikiリンク（`[[リンクテキスト]]`表記）のサポートと、リンク解決APIの実装に関する標準的な手順です。

**関連ファイル:**

- `src/lib/milkdown/wiki-link-plugin.ts`: MilkdownエディタにWikiリンク機能を追加するプラグイン
- `src/routes/api/notes/resolve-link/+server.ts`: リンク解決APIの実装
- `tests/integration/resolve-link.test.ts`: リンク解決APIの統合テスト

**ステップ:**

1.  **Milkdownプラグインの実装 (`wiki-link-plugin.ts`)**
    - `remark-wiki-link`をMilkdownのremarkパーサーに統合します。
    - wikiLinkノードを定義し、`[[Wikiリンク]]`表記をサポートするように設定します。
    - HTMLレンダリング時のクラスや属性を指定します（例: `class="wiki-link"`）。
    - `toMarkdown`と`parseMarkdown`の実装を追加し、MarkdownとProseMirrorノード間の変換を可能にします。

2.  **リンク解決APIの実装 (`+server.ts`)**
    - `GET /api/notes/resolve-link?title=リンクテキスト`エンドポイントを実装します。
    - ユーザーのセッションを確認し、認証状態を検証します。
    - クエリパラメータの`title`からスラッグを生成し、データベースでノートを検索します。
    - 検索ロジックは以下の優先順位で実装します：
      - 完全一致するタイトル
      - 部分一致するタイトル
      - 最新の更新日時を持つノート（複数ヒットした場合）
    - 適切なレスポンスを返します（成功時は`{username, title}`、失敗時は適切なステータスコード）。

3.  **統合テストの実装 (`resolve-link.test.ts`)**
    - テスト用のデータベースをセットアップし、テストデータを挿入します。
    - 以下のテストケースを実装します：
      - 未認証リクエスト時の401エラー
      - `title`パラメータなし時の400エラー
      - 存在するタイトルでの正常レスポンス
      - 存在しないタイトルでの404エラー
      - 重複タイトル時の最新ノートの優先返却
      - 日本語タイトルのサポート
    - テストデータをクリーンアップする処理を実装します。

**重要事項:**

- **スラッグ生成:** `src/lib/utils/slug.ts`で実装されているスラッグ生成ロジックを一貫して使用します。
- **日本語対応:** Unicode文字や特殊文字を含むタイトルを適切に処理できるようにします。
- **フロントエンド連携:** リンククリック時のフロントエンド実装（`src/routes/[username]/[notetitle]/+page.svelte`）を考慮します。
- **エラーハンドリング:** 予期せぬエラーが発生した場合の適切なエラーログ出力とステータスコードの返却を実装します。
